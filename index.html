<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»ƒä¹ æ‰“å­— - æå‡ä½ çš„æ‰“å­—é€Ÿåº¦</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- å®æ—¶è¾“å…¥è¿›åº¦æ ·å¼ -->
    <style>
    #currentWord {
        font-family: 'Courier New', monospace;
        font-size: 2.5em;
        font-weight: bold;
        letter-spacing: 2px;
        margin: 20px 0;
        user-select: none;
    }
    
    /* æ­£ç¡®è¾“å…¥çš„å­—æ¯ - ç»¿è‰²èƒŒæ™¯ */
    .letter-correct {
        background-color: #4CAF50;
        color: white;
        padding: 4px 2px;
        border-radius: 4px;
        transition: all 0.2s ease;
    }
    
    /* é”™è¯¯è¾“å…¥çš„å­—æ¯ - çº¢è‰²èƒŒæ™¯ */
    .letter-wrong {
        background-color: #f44336;
        color: white;
        padding: 4px 2px;
        border-radius: 4px;
        animation: shake 0.3s ease-in-out;
    }
    
    /* å½“å‰æ­£åœ¨è¾“å…¥çš„å­—æ¯ - ç»¿è‰²èƒŒæ™¯é—ªçƒ */
    .letter-current {
        background-color: #8BC34A;
        color: white;
        padding: 4px 2px;
        border-radius: 4px;
        animation: pulse 1s infinite;
        box-shadow: 0 0 10px rgba(139, 195, 74, 0.6);
    }
    
    /* å¾…è¾“å…¥çš„å­—æ¯ - ç°è‰² */
    .letter-pending {
        color: #9e9e9e;
        padding: 4px 2px;
        transition: color 0.2s ease;
    }
    
    /* è„‰å†²åŠ¨ç”» */
    @keyframes pulse {
        0% {
            background-color: #8BC34A;
            transform: scale(1);
        }
        50% {
            background-color: #4CAF50;
            transform: scale(1.05);
        }
        100% {
            background-color: #8BC34A;
            transform: scale(1);
        }
    }
    
    /* æŠ–åŠ¨åŠ¨ç”» */
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-2px); }
        75% { transform: translateX(2px); }
    }
    
    /* å®ŒæˆåŠ¨ç”» */
    .letter-complete {
        background-color: #4CAF50;
        color: white;
        padding: 4px 2px;
        border-radius: 4px;
        animation: complete 0.6s ease-in-out;
    }
    
    @keyframes complete {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); background-color: #81C784; }
        100% { transform: scale(1); background-color: #4CAF50; }
    }
    </style>
</head>
<body>
    <div class="container">
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <header class="header">
            <div class="nav">
                <div class="nav-left">
                    <h1 class="logo">
                        <i class="fas fa-keyboard"></i>
                        ç»ƒä¹ æ‰“å­—
                    </h1>
                </div>
                <div class="nav-right">
                    <button id="themeToggle" class="theme-toggle" title="åˆ‡æ¢ä¸»é¢˜">
                        <i class="fas fa-moon"></i>
                    </button>
                    <button id="settingsBtn" class="settings-btn" title="è®¾ç½®">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
        <main class="main">
            <!-- è¯å…¸é€‰æ‹©ç•Œé¢ -->
            <div id="dictionarySelection" class="dictionary-selection">
                <h2>è¯å…¸é€‰æ‹©</h2>
                <div class="dictionary-grid">
                    <div class="dictionary-category">
                        <h3>è‹±è¯­å­¦ä¹ </h3>
                        <div class="dictionary-cards">
                            <div class="dictionary-card" data-dict="cet4">
                                <div class="card-header">
                                    <h4>CET-4</h4>
                                    <span class="check-icon">âœ“</span>
                                </div>
                                <p>å¤§å­¦è‹±è¯­å››çº§è¯æ±‡</p>
                                <div class="word-count">360è¯ Â· 18ç« èŠ‚</div>
                            </div>
                            <div class="dictionary-card" data-dict="cet6">
                                <div class="card-header">
                                    <h4>CET-6</h4>
                                </div>
                                <p>å¤§å­¦è‹±è¯­å…­çº§è¯æ±‡</p>
                                <div class="word-count">400è¯ Â· 20ç« èŠ‚</div>
                            </div>
                            <div class="dictionary-card" data-dict="gmat">
                                <div class="card-header">
                                    <h4>GMAT</h4>
                                </div>
                                <p>GMAT è¯æ±‡</p>
                                <div class="word-count">400è¯ Â· 20ç« èŠ‚</div>
                            </div>
                            <div class="dictionary-card" data-dict="gre">
                                <div class="card-header">
                                    <h4>GRE</h4>
                                </div>
                                <p>GRE è¯æ±‡</p>
                                <div class="word-count">420è¯ Â· 21ç« èŠ‚</div>
                            </div>
                            <div class="dictionary-card" data-dict="ielts">
                                <div class="card-header">
                                    <h4>IELTS</h4>
                                </div>
                                <p>é›…æ€è¯æ±‡</p>
                                <div class="word-count">420è¯ Â· 21ç« èŠ‚</div>
                            </div>
                            <div class="dictionary-card" data-dict="kaoyan">
                                <div class="card-header">
                                    <h4>è€ƒç ”</h4>
                                </div>
                                <p>ç ”ç©¶ç”Ÿè‹±è¯­å…¥å­¦è€ƒè¯•è¯æ±‡</p>
                                <div class="word-count">420è¯ Â· 21ç« èŠ‚</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç« èŠ‚é€‰æ‹©ç•Œé¢ -->
            <div id="chapterSelection" class="chapter-selection hidden">
                <div class="chapter-header">
                    <button id="backToDict" class="back-btn">
                        <i class="fas fa-arrow-left"></i>
                        è¿”å›è¯å…¸é€‰æ‹©
                    </button>
                    <h2 id="selectedDictTitle">ç« èŠ‚é€‰æ‹©</h2>
                </div>
                <div class="chapter-grid" id="chapterGrid">
                    <!-- ç« èŠ‚å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>

            <!-- è¯­éŸ³æ¿€æ´»æç¤º -->
            <div id="speechActivationPrompt" class="speech-activation-prompt hidden">
                <div class="prompt-overlay"></div>
                <div class="prompt-content">
                    <div class="prompt-icon">ğŸ”Š</div>
                    <h3>å¯ç”¨è¯­éŸ³æœ—è¯»åŠŸèƒ½</h3>
                    <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ¥å¯ç”¨å•è¯æœ—è¯»åŠŸèƒ½ï¼Œè¿™æ ·æ¯ä¸ªå•è¯éƒ½ä¼šè‡ªåŠ¨æ’­æ”¾å‘éŸ³</p>
                    <button id="activateSpeechBtn" class="activate-speech-btn">
                        <i class="fas fa-volume-up"></i> å¯ç”¨è¯­éŸ³æœ—è¯»
                    </button>
                    <button id="skipSpeechBtn" class="skip-speech-btn">
                        æš‚æ—¶è·³è¿‡
                    </button>
                    <div class="prompt-note">
                        <small>ğŸ’¡ ä½ å¯ä»¥éšæ—¶åœ¨è®¾ç½®ä¸­é‡æ–°å¯ç”¨è¯­éŸ³åŠŸèƒ½</small>
                    </div>
                </div>
            </div>

            <!-- æ‰“å­—ç»ƒä¹ ç•Œé¢ -->
            <div id="typingInterface" class="typing-interface hidden">
                <!-- ç»Ÿè®¡ä¿¡æ¯é¢æ¿ -->
                <div class="stats-panel">
                    <div class="stat-item">
                        <div class="stat-label">æ—¶é—´</div>
                        <div class="stat-value" id="timeValue">00:01</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">è¾“å…¥æ•°</div>
                        <div class="stat-value" id="inputCount">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">é€Ÿåº¦</div>
                        <div class="stat-value" id="speedValue">0.00</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">æ­£ç¡®æ•°</div>
                        <div class="stat-value" id="correctCount">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">æ­£ç¡®ç‡</div>
                        <div class="stat-value" id="accuracyValue">0.00</div>
                    </div>
                </div>

                <!-- å•è¯ç»ƒä¹ åŒºåŸŸ -->
                <div class="word-practice-area">
                    <div class="current-word-container">
                        <div class="word-display">
                            <div id="currentWord" class="current-word">possess</div>
                            <button id="pronounceBtn" class="pronounce-btn">
                                <i class="fas fa-volume-up"></i>
                            </button>
                        </div>
                        <div class="phonetic-display">
                            <span class="phonetic-us">US: [pÉ™Ëˆzes]</span>
                            <span class="phonetic-uk">UK: [pÉ™Ëˆzes]</span>
                        </div>
                        <div class="meaning-display">å ç”¨ï¼Œæ‹¥æœ‰</div>
                        <div class="pronunciation-tip">
                            <small>ğŸ’¡ å•è¯ä¼šè‡ªåŠ¨æœ—è¯»ï¼Œä¹Ÿå¯ç‚¹å‡»å‘éŸ³æŒ‰é’®æ‰‹åŠ¨æœ—è¯»</small>
                            <div id="chromeTip" style="display: none; margin-top: 8px; padding: 8px; background: #fff3e0; border: 1px solid #ff9800; border-radius: 4px; font-size: 12px;">
                                ğŸ”§ <strong>Chromeç”¨æˆ·æç¤ºï¼š</strong><br>
                                å¦‚æœå¬ä¸åˆ°æœ—è¯»ï¼Œè¯·åœ¨åœ°å€æ è¾“å…¥ <code>chrome://settings/content/sound</code><br>
                                åœ¨"å…è®¸"éƒ¨åˆ†æ·»åŠ æœ¬ç½‘ç«™åœ°å€ï¼Œç„¶ååˆ·æ–°é¡µé¢
                            </div>
                        </div>
                    </div>
                    
                    <div class="input-container">
                        <input type="text" id="wordInput" class="word-input" placeholder="è¯·è¾“å…¥å•è¯..." autocomplete="off" spellcheck="false">
                        <div class="input-feedback" id="inputFeedback"></div>
                    </div>
                </div>

                <!-- æ§åˆ¶æŒ‰é’® -->
                <div class="controls">
                    <button id="backToChapter" class="control-btn secondary">
                        <i class="fas fa-arrow-left"></i>
                        è¿”å›ç« èŠ‚
                    </button>
                    <button id="skipWord" class="control-btn">
                        <i class="fas fa-forward"></i>
                        è·³è¿‡å•è¯
                    </button>
                    <button id="resetPractice" class="control-btn">
                        <i class="fas fa-redo"></i>
                        é‡æ–°å¼€å§‹
                    </button>
                </div>
            </div>

        </main>

        <!-- è®¾ç½®é¢æ¿ -->
        <div id="settingsPanel" class="settings-panel hidden">
            <div class="settings-content">
                <h3>è®¾ç½®</h3>
                <div class="setting-item">
                    <label>ç»ƒä¹ æ—¶é•¿ (åˆ†é’Ÿ)</label>
                    <select id="durationSetting">
                        <option value="1">1 åˆ†é’Ÿ</option>
                        <option value="3" selected>3 åˆ†é’Ÿ</option>
                        <option value="5">5 åˆ†é’Ÿ</option>
                        <option value="10">10 åˆ†é’Ÿ</option>
                        <option value="0">æ— é™åˆ¶</option>
                    </select>
                </div>
                <div class="setting-item">
                    <label>éŸ³æ•ˆåé¦ˆ</label>
                    <input type="checkbox" id="soundSetting" checked>
                </div>
                <div class="setting-item">
                    <label>æ‰“å­—éŸ³æ•ˆ</label>
                    <input type="checkbox" id="typingSoundSetting" checked>
                </div>
                <div class="setting-item">
                    <label>æ˜¾ç¤ºè™šæ‹Ÿé”®ç›˜</label>
                    <input type="checkbox" id="keyboardSetting" checked>
                </div>
                <div class="setting-item">
                    <label>å­—ä½“å¤§å°</label>
                    <select id="fontSizeSetting">
                        <option value="16">å°</option>
                        <option value="18" selected>ä¸­</option>
                        <option value="20">å¤§</option>
                        <option value="24">ç‰¹å¤§</option>
                    </select>
                </div>
                <button id="closeSettings" class="close-btn">å…³é—­</button>
            </div>
        </div>

        <!-- è‡ªå®šä¹‰æ–‡æœ¬é¢æ¿ -->
        <div id="customTextPanel" class="custom-text-panel hidden">
            <div class="custom-text-content">
                <h3>è‡ªå®šä¹‰ç»ƒä¹ æ–‡æœ¬</h3>
                <textarea id="customTextInput" placeholder="åœ¨è¿™é‡Œè¾“å…¥ä½ æƒ³è¦ç»ƒä¹ çš„æ–‡æœ¬..."></textarea>
                <div class="custom-text-controls">
                    <button id="saveCustomText" class="save-btn">ä¿å­˜å¹¶å¼€å§‹</button>
                    <button id="closeCustomText" class="close-btn">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <script src="words-data.js"></script>
    <script src="analytics.js"></script>
    <script src="script.js"></script>
    
    <!-- è¯æ±‡æ•°æ®éªŒè¯è„šæœ¬ -->
    <script>
    // ç«‹å³æ£€æŸ¥è¯æ±‡æ•°æ®æ˜¯å¦åŠ è½½
    console.log('ğŸ” ç«‹å³æ£€æŸ¥è¯æ±‡æ•°æ®åŠ è½½çŠ¶æ€');
    console.log('  typeof wordsDatabase:', typeof wordsDatabase);
    console.log('  window.wordsDatabase:', !!window.wordsDatabase);
    
        // å¦‚æœwordsDatabaseå­˜åœ¨ä½†window.wordsDatabaseä¸å­˜åœ¨ï¼Œæ‰‹åŠ¨è®¾ç½®
        if (typeof wordsDatabase !== 'undefined' && !window.wordsDatabase) {
            window.wordsDatabase = wordsDatabase;
            window.getChapterWords = getChapterWords;
            window.getTotalChapters = getTotalChapters;
            console.log('âœ… æ‰‹åŠ¨è®¾ç½®å…¨å±€è¯æ±‡æ•°æ®');
        }
        
        // åŠ è½½ä¿å­˜çš„ä¸»é¢˜
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        const themeIcon = document.querySelector('#themeToggle i');
        if (themeIcon) {
            themeIcon.className = savedTheme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
        }
        console.log('ğŸ¨ åŠ è½½ä¸»é¢˜:', savedTheme);
    </script>
    
    <!-- ç´§æ€¥ä¿®å¤è„šæœ¬ -->
    <script>
    // ç¡®ä¿DOMåŠ è½½å®Œæˆåæ‰§è¡Œ
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', fixClickEvents);
    } else {
        fixClickEvents();
    }
    
    function fixClickEvents() {
        console.log('ğŸ”§ ç´§æ€¥ä¿®å¤ - é‡æ–°ç»‘å®šç‚¹å‡»äº‹ä»¶');
        
        // ç­‰å¾…è¯æ±‡æ•°æ®åŠ è½½
        if (!window.wordsDatabase) {
            console.log('â³ ç­‰å¾…è¯æ±‡æ•°æ®åŠ è½½...');
            setTimeout(fixClickEvents, 500);  // 500msåé‡è¯•
            return;
        }
        
        // æ£€æŸ¥words-data.jsæ˜¯å¦æ­£ç¡®åŠ è½½
        console.log('ğŸ“Š æ£€æŸ¥è¯æ±‡æ•°æ®:');
        console.log('  wordsDatabaseå­˜åœ¨:', !!window.wordsDatabase);
        if (window.wordsDatabase) {
            console.log('  å¯ç”¨è¯å…¸:', Object.keys(window.wordsDatabase));
            console.log('  CET4ç« èŠ‚æ•°:', window.wordsDatabase.cet4 ? Object.keys(window.wordsDatabase.cet4).length : 0);
            console.log('  CET6ç« èŠ‚æ•°:', window.wordsDatabase.cet6 ? Object.keys(window.wordsDatabase.cet6).length : 0);
            
            // è¯¦ç»†æ£€æŸ¥æ¯ä¸ªè¯å…¸çš„æ•°æ®
            Object.keys(window.wordsDatabase).forEach(dict => {
                const chapters = Object.keys(window.wordsDatabase[dict]);
                console.log(`  ${dict}:`, chapters.map(ch => {
                    const words = window.wordsDatabase[dict][ch];
                    return `${ch}(${words.length}è¯)`;
                }).join(', '));
            });
        }
        
        // ç›´æ¥è·å–æ‰€æœ‰è¯å…¸å¡ç‰‡
        const cards = document.querySelectorAll('.dictionary-card');
        console.log('ğŸ” æ‰¾åˆ°è¯å…¸å¡ç‰‡:', cards.length);
        
        // ä¸ºæ¯ä¸ªå¡ç‰‡ç»‘å®šç‚¹å‡»äº‹ä»¶
        cards.forEach(function(card, index) {
            const dictKey = card.getAttribute('data-dict');
            console.log('ğŸ“Œ ç»‘å®šå¡ç‰‡:', dictKey);
            
            // ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§äº‹ä»¶ç›‘å¬å™¨
            card.removeEventListener('click', handleCardClick);
            
            // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
            card.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('âœ… ç‚¹å‡»æˆåŠŸ:', dictKey);
                
                // ç›´æ¥æ‰§è¡Œç•Œé¢åˆ‡æ¢
                const dictionarySelection = document.getElementById('dictionarySelection');
                const chapterSelection = document.getElementById('chapterSelection');
                const title = document.getElementById('selectedDictTitle');
                
                if (dictionarySelection && chapterSelection && title) {
                    // éšè—è¯å…¸é€‰æ‹©ç•Œé¢
                    dictionarySelection.classList.add('hidden');
                    // æ˜¾ç¤ºç« èŠ‚é€‰æ‹©ç•Œé¢
                    chapterSelection.classList.remove('hidden');
                    // æ›´æ–°æ ‡é¢˜
                    title.textContent = dictKey.toUpperCase() + ' - ç« èŠ‚é€‰æ‹©';
                    
                    // ç”Ÿæˆç« èŠ‚å†…å®¹
                    generateChapters(dictKey);
                    
                    console.log('ğŸ¯ ç•Œé¢åˆ‡æ¢æˆåŠŸ!');
                } else {
                    console.error('âŒ æ‰¾ä¸åˆ°å¿…è¦çš„DOMå…ƒç´ ');
                }
            });
        });
        
        // ç»‘å®šè¿”å›æŒ‰é’®
        const backBtn = document.getElementById('backToDict');
        if (backBtn) {
            backBtn.addEventListener('click', function() {
                console.log('ğŸ”™ è¿”å›è¯å…¸é€‰æ‹©');
                showDictionarySelection();
            });
        }
        
        const backToChapterBtn = document.getElementById('backToChapter');
        if (backToChapterBtn) {
            backToChapterBtn.addEventListener('click', function() {
                console.log('ğŸ”™ è¿”å›ç« èŠ‚é€‰æ‹©');
                showChapterSelection();
            });
        }
        
        // ç»‘å®šè¾“å…¥äº‹ä»¶
        const wordInput = document.getElementById('wordInput');
        if (wordInput) {
            wordInput.addEventListener('input', handleWordInput);
            wordInput.addEventListener('keydown', handleKeyDown);
            console.log('âœ… è¾“å…¥äº‹ä»¶å·²ç»‘å®š');
        }
        
        // ç»‘å®šå‘éŸ³æŒ‰é’®
        const pronounceBtn = document.getElementById('pronounceBtn');
        if (pronounceBtn) {
            pronounceBtn.addEventListener('click', function() {
                if (window.chapterWords && window.chapterWords[window.currentWordIndex]) {
                    speakWord(window.chapterWords[window.currentWordIndex].word);
                }
            });
        }
        
        // ç»‘å®šä¸»é¢˜åˆ‡æ¢æŒ‰é’®
        const themeToggle = document.getElementById('themeToggle');
        if (themeToggle) {
            themeToggle.addEventListener('click', function() {
                toggleTheme();
            });
            console.log('âœ… ä¸»é¢˜åˆ‡æ¢æŒ‰é’®å·²ç»‘å®š');
        }
        
        // ç»‘å®šè®¾ç½®æŒ‰é’®
        const settingsBtn = document.getElementById('settingsBtn');
        if (settingsBtn) {
            settingsBtn.addEventListener('click', function() {
                toggleSettings();
            });
            console.log('âœ… è®¾ç½®æŒ‰é’®å·²ç»‘å®š');
        }
        
        // ç»‘å®šè·³è¿‡å•è¯æŒ‰é’®
        const skipWordBtn = document.getElementById('skipWord');
        if (skipWordBtn) {
            skipWordBtn.addEventListener('click', function() {
                skipCurrentWord();
            });
            console.log('âœ… è·³è¿‡å•è¯æŒ‰é’®å·²ç»‘å®š');
        }
        
        // ç»‘å®šé‡æ–°å¼€å§‹æŒ‰é’®
        const resetPracticeBtn = document.getElementById('resetPractice');
        if (resetPracticeBtn) {
            resetPracticeBtn.addEventListener('click', function() {
                restartChapter();
            });
            console.log('âœ… é‡æ–°å¼€å§‹æŒ‰é’®å·²ç»‘å®š');
        }
    }
    
    function handleCardClick() {
        // å ä½å‡½æ•°ï¼Œç”¨äºremoveEventListener
    }
    
    // ç”Ÿæˆç« èŠ‚å†…å®¹
    function generateChapters(dictKey) {
        console.log('ğŸ“š ç”Ÿæˆç« èŠ‚å†…å®¹:', dictKey);
        
        // è¯¦ç»†æ£€æŸ¥è¯¥è¯å…¸çš„æ•°æ®ç»“æ„
        console.log('ğŸ” è¯å…¸æ•°æ®æ£€æŸ¥:');
        console.log('  wordsDatabase:', !!window.wordsDatabase);
        console.log('  è¯¥è¯å…¸å­˜åœ¨:', !!window.wordsDatabase[dictKey]);
        if (window.wordsDatabase[dictKey]) {
            console.log('  è¯¥è¯å…¸çš„ç« èŠ‚:', Object.keys(window.wordsDatabase[dictKey]));
            console.log('  ç¬¬ä¸€ç« ç¤ºä¾‹:', window.wordsDatabase[dictKey].chapter1);
        }
        
        const chapterGrid = document.getElementById('chapterGrid');
        if (!chapterGrid) {
            console.error('âŒ æ‰¾ä¸åˆ°ç« èŠ‚ç½‘æ ¼å®¹å™¨');
            return;
        }
        
        // æ¸…ç©ºç°æœ‰å†…å®¹
        chapterGrid.innerHTML = '';
        
        // è®¾ç½®ç½‘æ ¼å¸ƒå±€æ ·å¼
        chapterGrid.style.cssText = `
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        `;
        
        // åˆ›å»ºç« èŠ‚å¡ç‰‡
        for (let i = 1; i <= 20; i++) {
            const chapterCard = document.createElement('div');
            chapterCard.className = 'chapter-card';
            chapterCard.style.cssText = `
                border: 2px solid #e0e0e0;
                border-radius: 12px;
                padding: 20px;
                margin: 10px;
                text-align: center;
                background: #ffffff;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                transition: all 0.3s ease;
                min-height: 100px;
                display: flex;
                flex-direction: column;
                justify-content: center;
            `;
            
            // æ£€æŸ¥è¯¥ç« èŠ‚æ˜¯å¦æœ‰è¯æ±‡æ•°æ®
            let wordCount = 0;
            
            // ä¼˜å…ˆä½¿ç”¨å…¨å±€å‡½æ•°
            if (window.getChapterWords) {
                const words = window.getChapterWords(dictKey, i);
                wordCount = words.length;
                console.log(`ğŸ” ${dictKey} chapter${i}: ${wordCount} è¯æ±‡`);
            } else {
                // å¤‡ç”¨æ–¹æ³•
                const chapterKey = 'chapter' + i;
                if (window.wordsDatabase && window.wordsDatabase[dictKey] && window.wordsDatabase[dictKey][chapterKey]) {
                    wordCount = window.wordsDatabase[dictKey][chapterKey].length;
                    console.log(`âœ… ${dictKey} ${chapterKey} æœ‰ ${wordCount} ä¸ªè¯æ±‡`);
                } else {
                    console.log(`âŒ ${dictKey} ${chapterKey} æ²¡æœ‰æ•°æ®`);
                }
            }
            
            chapterCard.innerHTML = `
                <h4>Chapter ${i}</h4>
                <p>${wordCount} è¯</p>
            `;
            
            // å¦‚æœæœ‰è¯æ±‡æ•°æ®ï¼Œè®¾ç½®ä¸ºå¯ç‚¹å‡»
            if (wordCount > 0) {
                chapterCard.classList.add('available');
                chapterCard.style.cursor = 'pointer';
                chapterCard.style.borderColor = '#007bff';
                chapterCard.addEventListener('mouseover', function() {
                    chapterCard.style.backgroundColor = '#f0f8ff';
                    chapterCard.style.transform = 'translateY(-2px)';
                });
                chapterCard.addEventListener('mouseout', function() {
                    chapterCard.style.backgroundColor = '#ffffff';
                    chapterCard.style.transform = 'translateY(0)';
                });
                chapterCard.addEventListener('click', function() {
                    console.log('ğŸ¯ é€‰æ‹©ç« èŠ‚:', i, 'è¯æ±‡æ•°é‡:', wordCount);
                    
                    // å¼€å§‹æ‰“å­—ç»ƒä¹ 
                    window.currentDictionary = dictKey;
                    window.currentChapter = i;
                    window.currentWordIndex = 0;
                    
                    // åŠ è½½ç« èŠ‚å•è¯
                    if (window.getChapterWords) {
                        window.chapterWords = window.getChapterWords(dictKey, i);
                        console.log('ğŸ“š åŠ è½½ç« èŠ‚å•è¯:', window.chapterWords.length, 'ä¸ª');
                        
                        if (window.chapterWords.length > 0) {
                            showTypingInterface();
                        } else {
                            alert('è¯¥ç« èŠ‚æš‚æ— è¯æ±‡æ•°æ®');
                        }
                    } else {
                        alert('è¯æ±‡åŠ è½½åŠŸèƒ½ä¸å¯ç”¨');
                    }
                });
            } else {
                chapterCard.classList.add('unavailable');
                chapterCard.style.opacity = '0.5';
                chapterCard.style.cursor = 'not-allowed';
                chapterCard.style.borderColor = '#cccccc';
                chapterCard.style.color = '#999999';
            }
            
            chapterGrid.appendChild(chapterCard);
        }
        
        console.log('âœ… ç« èŠ‚å†…å®¹ç”Ÿæˆå®Œæˆ');
    }
    
    // æ˜¾ç¤ºæ‰“å­—ç»ƒä¹ ç•Œé¢
    function showTypingInterface() {
        console.log('ğŸ“± æ˜¾ç¤ºæ‰“å­—ç»ƒä¹ ç•Œé¢');
        
        // éšè—å…¶ä»–ç•Œé¢
        const dictionarySelection = document.getElementById('dictionarySelection');
        const chapterSelection = document.getElementById('chapterSelection');
        const typingInterface = document.getElementById('typingInterface');
        
        if (dictionarySelection) dictionarySelection.classList.add('hidden');
        if (chapterSelection) chapterSelection.classList.add('hidden');
        if (typingInterface) typingInterface.classList.remove('hidden');
        
        // æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºè¯­éŸ³æ¿€æ´»æç¤º
        setTimeout(() => {
            if (typeof showSpeechActivationPrompt === 'function') {
                showSpeechActivationPrompt();
            }
        }, 500);
        
        // è·Ÿè¸ªç»ƒä¹ å¼€å§‹
        if (typeof trackPracticeStart === 'function') {
            trackPracticeStart(window.currentDictionary, window.currentChapter);
        }
        
        // åŠ è½½å½“å‰å•è¯
        loadCurrentWord();
        
        // é‡ç½®ç»Ÿè®¡
        resetStats();
        
        // èšç„¦è¾“å…¥æ¡†
        const wordInput = document.getElementById('wordInput');
        if (wordInput) {
            wordInput.focus();
            wordInput.value = '';
        }
    }
    
    // åŠ è½½å½“å‰å•è¯
    function loadCurrentWord() {
        if (!window.chapterWords || window.currentWordIndex >= window.chapterWords.length) {
            completeChapter();
            return;
        }
        
        const currentWord = window.chapterWords[window.currentWordIndex];
        console.log('ğŸ“– å½“å‰å•è¯:', currentWord);
        
        // æ˜¾ç¤ºå•è¯ä¿¡æ¯
        const currentWordEl = document.getElementById('currentWord');
        const phoneticUS = document.querySelector('.phonetic-us');
        const phoneticUK = document.querySelector('.phonetic-uk');
        const meaningDisplay = document.querySelector('.meaning-display');
        
        // åˆ›å»ºå¸¦è¿›åº¦æ˜¾ç¤ºçš„å•è¯
        if (currentWordEl) {
            updateWordProgress(currentWord.word, '');
        }
        if (phoneticUS) phoneticUS.textContent = currentWord.phonetic.us;
        if (phoneticUK) phoneticUK.textContent = currentWord.phonetic.uk;
        if (meaningDisplay) meaningDisplay.textContent = currentWord.meaning;
        
        // è‡ªåŠ¨æœ—è¯»å•è¯
        speakWord(currentWord.word);
        
        // æ¸…ç©ºè¾“å…¥æ¡†
        const wordInput = document.getElementById('wordInput');
        if (wordInput) {
            wordInput.value = '';
            wordInput.focus();
        }
    }
    
    // æœ—è¯»å•è¯
    function speakWord(text) {
        // æ£€æŸ¥æœ—è¯»è®¾ç½®
        if (localStorage.getItem('soundEnabled') === 'false') {
            console.log('ğŸ”‡ æœ—è¯»å·²ç¦ç”¨');
            return;
        }
        
        console.log('ğŸ”Š æœ—è¯»å•è¯:', text);
        
        if ('speechSynthesis' in window) {
            try {
                speechSynthesis.cancel();
                
                setTimeout(() => {
                    const utterance = new SpeechSynthesisUtterance(text);
                    const voices = speechSynthesis.getVoices();
                    
                    // é€‰æ‹©è‹±è¯­è¯­éŸ³
                    const englishVoice = voices.find(v => 
                        v.lang.includes('en-US') || v.lang.includes('en')
                    );
                    if (englishVoice) {
                        utterance.voice = englishVoice;
                    }
                    
                    utterance.lang = 'en-US';
                    utterance.volume = 1.0;
                    utterance.rate = 0.8;
                    utterance.pitch = 1.0;
                    
                    utterance.onstart = () => console.log('ğŸµ å¼€å§‹æœ—è¯»');
                    utterance.onend = () => console.log('ğŸµ æœ—è¯»å®Œæˆ');
                    utterance.onerror = (e) => {
                        console.error('æœ—è¯»é”™è¯¯:', e);
                        playNotificationSound();
                    };
                    
                    speechSynthesis.speak(utterance);
                }, 100);
            } catch (error) {
                console.error('æœ—è¯»å¤±è´¥:', error);
                playNotificationSound();
            }
        } else {
            console.warn('æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åˆæˆ');
            playNotificationSound();
        }
    }
    
    // æ›´æ–°å•è¯è¾“å…¥è¿›åº¦æ˜¾ç¤º
    function updateWordProgress(targetWord, inputText) {
        const currentWordEl = document.getElementById('currentWord');
        if (!currentWordEl) return;
        
        let htmlContent = '';
        
        for (let i = 0; i < targetWord.length; i++) {
            const letter = targetWord[i];
            let letterClass = '';
            
            if (i < inputText.length) {
                // å·²è¾“å…¥çš„å­—æ¯
                if (inputText[i] === letter) {
                    letterClass = 'letter-correct';  // æ­£ç¡®çš„å­—æ¯
                } else {
                    letterClass = 'letter-wrong';    // é”™è¯¯çš„å­—æ¯
                }
            } else if (i === inputText.length) {
                // å½“å‰æ­£åœ¨è¾“å…¥çš„å­—æ¯
                letterClass = 'letter-current';
            } else {
                // æœªè¾“å…¥çš„å­—æ¯
                letterClass = 'letter-pending';
            }
            
            htmlContent += `<span class="${letterClass}">${letter}</span>`;
        }
        
        currentWordEl.innerHTML = htmlContent;
    }
    
    // æ’­æ”¾æç¤ºéŸ³
    function playNotificationSound() {
        if (typeof(AudioContext) !== "undefined" || typeof(webkitAudioContext) !== "undefined") {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.6, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
            } catch (e) {
                console.error('æ’­æ”¾æç¤ºéŸ³å¤±è´¥:', e);
            }
        }
    }
    
    // é‡ç½®ç»Ÿè®¡
    function resetStats() {
        window.startTime = Date.now();
        window.totalInputs = 0;
        window.correctInputs = 0;
        updateStats();
    }
    
    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    function updateStats() {
        const timeValue = document.getElementById('timeValue');
        const inputCount = document.getElementById('inputCount');
        const speedValue = document.getElementById('speedValue');
        const correctCount = document.getElementById('correctCount');
        const accuracyValue = document.getElementById('accuracyValue');
        
        if (window.startTime) {
            const elapsed = Math.floor((Date.now() - window.startTime) / 1000);
            if (timeValue) timeValue.textContent = elapsed;
        }
        
        if (inputCount) inputCount.textContent = window.totalInputs || 0;
        if (correctCount) correctCount.textContent = window.correctInputs || 0;
        
        const accuracy = window.totalInputs > 0 ? Math.round((window.correctInputs / window.totalInputs) * 100) : 100;
        if (accuracyValue) accuracyValue.textContent = accuracy + '%';
        
        const minutes = window.startTime ? (Date.now() - window.startTime) / 60000 : 1;
        const speed = Math.round((window.correctInputs || 0) / minutes);
        if (speedValue) speedValue.textContent = speed;
    }
    
    // å¤„ç†å•è¯è¾“å…¥
    function handleWordInput(e) {
        const input = e.target.value;
        const currentWord = window.chapterWords[window.currentWordIndex];
        
        if (!currentWord) return;
        
        const targetWord = currentWord.word;
        const inputFeedback = document.getElementById('inputFeedback');
        
        // å®æ—¶æ›´æ–°å•è¯è¿›åº¦æ˜¾ç¤º
        updateWordProgress(targetWord, input);
        
        // é€å­—ç¬¦æ£€æŸ¥
        let isCorrect = true;
        for (let i = 0; i < input.length; i++) {
            if (i >= targetWord.length || input[i] !== targetWord[i]) {
                isCorrect = false;
                break;
            }
        }
        
        // æ›´æ–°åé¦ˆæ˜¾ç¤º
        if (inputFeedback) {
            if (input.length === 0) {
                inputFeedback.textContent = '';
                inputFeedback.className = '';
            } else if (isCorrect) {
                if (input.length === targetWord.length) {
                    inputFeedback.textContent = 'âœ… å®Œæˆï¼';
                    inputFeedback.className = 'correct complete';
                } else {
                    inputFeedback.textContent = 'âœ“ æ­£ç¡®';
                    inputFeedback.className = 'correct';
                }
            } else {
                inputFeedback.textContent = 'âŒ é”™è¯¯';
                inputFeedback.className = 'error';
                
                // æ£€æŸ¥æ˜¯å¦å¯ç”¨ä¸¥æ ¼æ¨¡å¼
                const strictMode = localStorage.getItem('strictMode') !== 'false';
                if (strictMode) {
                    // ä¸¥æ ¼æ¨¡å¼ï¼šé”™è¯¯æ—¶æ¸…ç©ºè¾“å…¥
                    setTimeout(() => {
                        e.target.value = '';
                        inputFeedback.textContent = '';
                        inputFeedback.className = '';
                        // é‡ç½®è¿›åº¦æ˜¾ç¤º
                        updateWordProgress(targetWord, '');
                    }, 500);
                } else {
                    // éä¸¥æ ¼æ¨¡å¼ï¼šå…è®¸ç»§ç»­è¾“å…¥ï¼Œä½†æ ‡è®°é”™è¯¯
                    setTimeout(() => {
                        inputFeedback.textContent = '';
                        inputFeedback.className = '';
                    }, 1000);
                }
                
                playErrorSound();
                return;
            }
        }
        
        // ç»Ÿè®¡è¾“å…¥
        window.totalInputs = (window.totalInputs || 0) + 1;
        if (isCorrect) {
            window.correctInputs = (window.correctInputs || 0) + 1;
        }
        
        updateStats();
        
        // æ’­æ”¾æ‰“å­—éŸ³æ•ˆ
        if (isCorrect) {
            playTypingSound();
        }
        
        // å®Œæˆå½“å‰å•è¯
        if (isCorrect && input.length === targetWord.length) {
            // æ·»åŠ å®ŒæˆåŠ¨ç”»æ•ˆæœ
            const currentWordEl = document.getElementById('currentWord');
            if (currentWordEl) {
                const letters = currentWordEl.querySelectorAll('span');
                letters.forEach(letter => {
                    letter.className = 'letter-complete';
                });
            }
            
            setTimeout(() => {
                window.currentWordIndex++;
                loadCurrentWord();
            }, 800);
        }
    }
    
    // å¤„ç†æŒ‰é”®
    function handleKeyDown(e) {
        // Enteré”®è·³è¿‡å½“å‰å•è¯
        if (e.key === 'Enter') {
            e.preventDefault();
            skipCurrentWord();
        }
        
        // Escapeé”®è¿”å›ç« èŠ‚é€‰æ‹©
        if (e.key === 'Escape') {
            e.preventDefault();
            showChapterSelection();
        }
        
        // ç©ºæ ¼é”®é‡æ–°æœ—è¯»å•è¯
        if (e.key === ' ' || e.key === 'Space') {
            e.preventDefault();
            if (window.chapterWords && window.chapterWords[window.currentWordIndex]) {
                speakWord(window.chapterWords[window.currentWordIndex].word);
            }
        }
        
        // Ré”®é‡æ–°å¼€å§‹åŠŸèƒ½å·²ç§»é™¤
        
        // Tabé”®è·³è¿‡å½“å‰å•è¯ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
        if (e.key === 'Tab') {
            e.preventDefault();
            skipCurrentWord();
        }
    }
    
    // æ’­æ”¾æ‰“å­—éŸ³æ•ˆ
    function playTypingSound() {
        // æ£€æŸ¥éŸ³æ•ˆè®¾ç½®
        if (localStorage.getItem('typingSoundEnabled') === 'false') {
            return;
        }
        
        if (typeof(AudioContext) !== "undefined" || typeof(webkitAudioContext) !== "undefined") {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.1);
            } catch (e) {
                console.error('æ’­æ”¾æ‰“å­—éŸ³æ•ˆå¤±è´¥:', e);
            }
        }
    }
    
    // æ’­æ”¾é”™è¯¯éŸ³æ•ˆ
    function playErrorSound() {
        // æ£€æŸ¥éŸ³æ•ˆè®¾ç½®
        if (localStorage.getItem('typingSoundEnabled') === 'false') {
            return;
        }
        
        if (typeof(AudioContext) !== "undefined" || typeof(webkitAudioContext) !== "undefined") {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (e) {
                console.error('æ’­æ”¾é”™è¯¯éŸ³æ•ˆå¤±è´¥:', e);
            }
        }
    }
    
    // å®Œæˆç« èŠ‚
    function completeChapter() {
        console.log('ğŸ‰ ç« èŠ‚å®Œæˆï¼');
        const accuracy = window.totalInputs > 0 ? Math.round((window.correctInputs / window.totalInputs) * 100) : 100;
        alert(`æ­å–œå®Œæˆ ${window.currentDictionary.toUpperCase()} Chapter ${window.currentChapter}ï¼\n\næ€»è®¡è¾“å…¥: ${window.totalInputs}\næ­£ç¡®è¾“å…¥: ${window.correctInputs}\nå‡†ç¡®ç‡: ${accuracy}%`);
        
        // è¿”å›ç« èŠ‚é€‰æ‹©
        showChapterSelection();
    }
    
    // æ›´æ–°çš„æ˜¾ç¤ºç« èŠ‚é€‰æ‹©ç•Œé¢å‡½æ•°
    function showChapterSelection() {
        console.log('ğŸ“± æ˜¾ç¤ºç« èŠ‚é€‰æ‹©ç•Œé¢');
        
        const dictionarySelection = document.getElementById('dictionarySelection');
        const chapterSelection = document.getElementById('chapterSelection');
        const typingInterface = document.getElementById('typingInterface');
        
        if (dictionarySelection) dictionarySelection.classList.add('hidden');
        if (chapterSelection) chapterSelection.classList.remove('hidden');
        if (typingInterface) typingInterface.classList.add('hidden');
        
        // å¦‚æœæœ‰å½“å‰è¯å…¸ï¼Œé‡æ–°ç”Ÿæˆç« èŠ‚
        if (window.currentDictionary) {
            generateChapters(window.currentDictionary);
        }
    }
    
    // ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½
    function toggleTheme() {
        const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        
        // æ›´æ–°ä¸»é¢˜å›¾æ ‡
        const themeIcon = document.querySelector('#themeToggle i');
        if (themeIcon) {
            themeIcon.className = newTheme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
        }
        
        console.log('ğŸ¨ ä¸»é¢˜å·²åˆ‡æ¢ä¸º:', newTheme);
    }
    
    // è®¾ç½®é¢æ¿åˆ‡æ¢
    function toggleSettings() {
        console.log('âš™ï¸ æ‰“å¼€è®¾ç½®é¢æ¿');
        
        // åˆ›å»ºè®¾ç½®å¼¹çª—
        const existingModal = document.getElementById('settingsModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        const modal = document.createElement('div');
        modal.id = 'settingsModal';
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        `;
        
        modal.innerHTML = `
            <div style="
                background: white;
                border-radius: 12px;
                padding: 30px;
                max-width: 500px;
                width: 90%;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            ">
                <h3 style="margin-top: 0; color: #333; font-size: 1.5em;">âš™ï¸ è®¾ç½®</h3>
                
                <div style="margin: 20px 0;">
                    <label style="display: flex; align-items: center; margin: 15px 0; font-size: 1.1em;">
                        <input type="checkbox" id="soundSetting" style="margin-right: 10px;">
                        ğŸ”Š å¯ç”¨æœ—è¯»åŠŸèƒ½
                    </label>
                    
                    <div style="margin: 15px 0;">
                        <label style="display: block; margin-bottom: 5px; font-size: 1.1em;">
                            ğŸ”Š æœ—è¯»éŸ³é‡: <span id="volumeValue">100%</span>
                        </label>
                        <input type="range" id="volumeSetting" min="0" max="100" value="100" 
                               style="width: 100%; margin: 5px 0;">
                    </div>
                    
                    <label style="display: flex; align-items: center; margin: 15px 0; font-size: 1.1em;">
                        <input type="checkbox" id="typingSoundSetting" style="margin-right: 10px;">
                        ğŸµ å¯ç”¨æ‰“å­—éŸ³æ•ˆ
                    </label>
                    
                    <label style="display: flex; align-items: center; margin: 15px 0; font-size: 1.1em;">
                        <input type="checkbox" id="strictModeSetting" style="margin-right: 10px;">
                        ğŸ¯ ä¸¥æ ¼æ¨¡å¼ï¼ˆé”™è¯¯ç«‹å³é‡æ–°å¼€å§‹ï¼‰
                    </label>
                </div>
                
                <div style="margin: 20px 0;">
                    <h4 style="color: #333; margin: 15px 0;">ğŸ¨ ä¸»é¢˜é€‰æ‹©</h4>
                    <button onclick="setTheme('light')" style="
                        margin: 5px;
                        padding: 10px 15px;
                        border: 2px solid #ddd;
                        border-radius: 8px;
                        background: white;
                        cursor: pointer;
                    ">â˜€ï¸ æµ…è‰²ä¸»é¢˜</button>
                    <button onclick="setTheme('dark')" style="
                        margin: 5px;
                        padding: 10px 15px;
                        border: 2px solid #ddd;
                        border-radius: 8px;
                        background: #333;
                        color: white;
                        cursor: pointer;
                    ">ğŸŒ™ æ·±è‰²ä¸»é¢˜</button>
                </div>
                
                <div style="margin: 20px 0;">
                    <h4 style="color: #333; margin: 15px 0;">ğŸ® å¿«æ·é”®</h4>
                    <div style="font-size: 0.9em; color: #666;">
                        <p>â€¢ <strong>Enter</strong> æˆ– <strong>Tab</strong>: è·³è¿‡å½“å‰å•è¯</p>
                        <p>â€¢ <strong>ç©ºæ ¼</strong>: é‡æ–°æœ—è¯»å•è¯</p>
                        <p>â€¢ <strong>Escape</strong>: è¿”å›ç« èŠ‚é€‰æ‹©</p>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 25px;">
                    <button onclick="closeSettings()" style="
                        background: #007bff;
                        color: white;
                        border: none;
                        padding: 12px 25px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 1em;
                    ">âœ… ç¡®å®š</button>
                    <button onclick="resetSettings()" style="
                        background: #6c757d;
                        color: white;
                        border: none;
                        padding: 12px 25px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 1em;
                        margin-left: 10px;
                    ">ğŸ”„ é‡ç½®</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // åŠ è½½å½“å‰è®¾ç½®
        loadSettingsValues();
        
        // ç‚¹å‡»èƒŒæ™¯å…³é—­
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeSettings();
            }
        });
    }
    
    // è®¾ç½®ä¸»é¢˜
    window.setTheme = function(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
        
        const themeIcon = document.querySelector('#themeToggle i');
        if (themeIcon) {
            themeIcon.className = theme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
        }
        
        console.log('ğŸ¨ ä¸»é¢˜è®¾ç½®ä¸º:', theme);
    };
    
    // åŠ è½½è®¾ç½®å€¼
    function loadSettingsValues() {
        const soundSetting = document.getElementById('soundSetting');
        const typingSoundSetting = document.getElementById('typingSoundSetting');
        const strictModeSetting = document.getElementById('strictModeSetting');
        const volumeSetting = document.getElementById('volumeSetting');
        const volumeValue = document.getElementById('volumeValue');
        
        if (soundSetting) {
            soundSetting.checked = localStorage.getItem('soundEnabled') !== 'false';
            soundSetting.addEventListener('change', function() {
                localStorage.setItem('soundEnabled', this.checked);
            });
        }
        
        if (volumeSetting && volumeValue) {
            // åŠ è½½ä¿å­˜çš„éŸ³é‡è®¾ç½®
            const savedVolume = localStorage.getItem('speechVolume') || '1.0';
            const volumePercent = Math.round(parseFloat(savedVolume) * 100);
            volumeSetting.value = volumePercent;
            volumeValue.textContent = volumePercent + '%';
            
            // ç›‘å¬éŸ³é‡å˜åŒ–
            volumeSetting.addEventListener('input', function() {
                const volume = this.value / 100;
                volumeValue.textContent = this.value + '%';
                localStorage.setItem('speechVolume', volume.toString());
                
                // æ›´æ–°å…¨å±€éŸ³é‡å˜é‡
                window.speechVolume = volume;
                // å¦‚æœscript.jsä¸­æœ‰speechVolumeå˜é‡ï¼Œä¹Ÿæ›´æ–°å®ƒ
                if (typeof speechVolume !== 'undefined') {
                    speechVolume = volume;
                }
                
                console.log('éŸ³é‡è®¾ç½®æ›´æ–°ä¸º:', volume);
            });
        }
        
        if (typingSoundSetting) {
            typingSoundSetting.checked = localStorage.getItem('typingSoundEnabled') !== 'false';
            typingSoundSetting.addEventListener('change', function() {
                localStorage.setItem('typingSoundEnabled', this.checked);
            });
        }
        
        if (strictModeSetting) {
            strictModeSetting.checked = localStorage.getItem('strictMode') !== 'false';
            strictModeSetting.addEventListener('change', function() {
                localStorage.setItem('strictMode', this.checked);
            });
        }
    }
    
    // å…³é—­è®¾ç½®
    window.closeSettings = function() {
        const modal = document.getElementById('settingsModal');
        if (modal) {
            modal.remove();
        }
    };
    
    // é‡ç½®è®¾ç½®
    window.resetSettings = function() {
        localStorage.removeItem('soundEnabled');
        localStorage.removeItem('typingSoundEnabled');
        localStorage.removeItem('strictMode');
        localStorage.removeItem('theme');
        
        // é‡æ–°åŠ è½½è®¾ç½®
        loadSettingsValues();
        setTheme('light');
        
        alert('âœ… è®¾ç½®å·²é‡ç½®ä¸ºé»˜è®¤å€¼');
    };
    
    // è·³è¿‡å½“å‰å•è¯
    function skipCurrentWord() {
        console.log('â­ï¸ è·³è¿‡å•è¯');
        
        if (!window.chapterWords || window.currentWordIndex >= window.chapterWords.length) {
            console.log('æ²¡æœ‰å¯è·³è¿‡çš„å•è¯');
            return;
        }
        
        // æ˜¾ç¤ºè·³è¿‡æç¤º
        const inputFeedback = document.getElementById('inputFeedback');
        if (inputFeedback) {
            inputFeedback.textContent = 'â­ï¸ å·²è·³è¿‡';
            inputFeedback.className = 'skipped';
            inputFeedback.style.color = '#ff9800';
        }
        
        // æ¸…ç©ºè¾“å…¥æ¡†
        const wordInput = document.getElementById('wordInput');
        if (wordInput) {
            wordInput.value = '';
        }
        
        // æ›´æ–°ç»Ÿè®¡ï¼ˆè·³è¿‡ç®—ä½œä¸€æ¬¡è¾“å…¥ï¼Œä½†ä¸ç®—æ­£ç¡®ï¼‰
        window.totalInputs = (window.totalInputs || 0) + 1;
        // è·³è¿‡ä¸å¢åŠ æ­£ç¡®æ•°
        updateStats();
        
        // å»¶è¿Ÿåè·³åˆ°ä¸‹ä¸€ä¸ªå•è¯
        setTimeout(() => {
            window.currentWordIndex++;
            if (window.currentWordIndex >= window.chapterWords.length) {
                completeChapter();
            } else {
                loadCurrentWord();
            }
        }, 600);
    }
    
    // é‡æ–°å¼€å§‹å½“å‰ç« èŠ‚
    function restartChapter() {
        console.log('ğŸ”„ é‡æ–°å¼€å§‹ç« èŠ‚');
        
        // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
        const currentProgress = window.currentWordIndex || 0;
        const totalWords = window.chapterWords ? window.chapterWords.length : 0;
        
        const confirmMessage = `ç¡®å®šè¦é‡æ–°å¼€å§‹å½“å‰ç« èŠ‚å—ï¼Ÿ\n\nå½“å‰è¿›åº¦: ${currentProgress + 1}/${totalWords}\né‡æ–°å¼€å§‹å°†æ¸…é™¤æ‰€æœ‰è¿›åº¦å’Œç»Ÿè®¡æ•°æ®ã€‚`;
        
        if (confirm(confirmMessage)) {
            // æ˜¾ç¤ºé‡æ–°å¼€å§‹æç¤º
            const inputFeedback = document.getElementById('inputFeedback');
            if (inputFeedback) {
                inputFeedback.textContent = 'ğŸ”„ é‡æ–°å¼€å§‹ä¸­...';
                inputFeedback.className = 'restarting';
                inputFeedback.style.color = '#2196F3';
            }
            
            // çŸ­æš‚å»¶è¿Ÿåé‡æ–°å¼€å§‹
            setTimeout(() => {
                // é‡ç½®åˆ°ç¬¬ä¸€ä¸ªå•è¯
                window.currentWordIndex = 0;
                
                // é‡ç½®ç»Ÿè®¡
                resetStats();
                
                // é‡æ–°åŠ è½½å½“å‰å•è¯
                loadCurrentWord();
                
                // æ¸…ç©ºè¾“å…¥æ¡†å’Œèšç„¦
                const wordInput = document.getElementById('wordInput');
                if (wordInput) {
                    wordInput.value = '';
                    wordInput.focus();
                }
                
                console.log('âœ… ç« èŠ‚å·²é‡æ–°å¼€å§‹');
            }, 300);
        }
    }
    </script>
</body>
</html>
